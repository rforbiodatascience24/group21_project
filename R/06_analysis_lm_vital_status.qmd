---
title: "06_analysis_lm_vital_status"
author:
- "Asta Zeuner - s203544 - azeuner"
- "Astrid Ginnerup - s203523 - AGinnerup"
- "Emma Dan√∏ - s203564 - EDanoe"
- "Andrea Kristensen - s193769 - AndreaMTK"
- "Yayi Wang - s243554 - Yayi0117"
html: 
    embed-resources: true
execute: 
  message: FALSE
  warning: FALSE
---

## Load libraries

```{r}
#| label: "load-libraries"
#| echo: TRUE
#| eval: TRUE 
#| output: FALSE  

library("tidyverse")
library("broom")
library("ggthemes")
library("ggrepel")
library("here")
```

## Loading data

```{r}
#| label: "load-data" 

expression_meta_data_aug <- read_tsv(file = here("data/05_expression_meta_data_aug.tsv.gz"))

```

# Linear model: dead or alive

## Selecting variables, grouping and nesting the data for the linear modelling

Want to make a linear model of the peptide expression levels and the overall survival.

Selecting the variables that we want to use for the linear modeling. NA's in "expression" are dropped.

```{r}
#| label: "selecting-variables-for-linear-modeling"

expression_meta_data_analysis6 <- expression_meta_data_aug |> 
  select(overall_survival, 
         peptide_target,
         expression) |> 
   drop_na(expression)

expression_meta_data_analysis6
```

Grouping the data by peptide_target and nesting the data so that each peptide_target gets a dataframe that contains the overall survival and the protein expression for the patients.

```{r}
#| label: "grouping-and-nesting-data"

expression_meta_data_analysis6_nested <- expression_meta_data_analysis6 |> 
  group_by(peptide_target) |> 
  nest() 

expression_meta_data_analysis6_nested
```

## Adding the linear model to the dataset

Adding the linear model to the data using mutate().

```{r}
#| label: "linear-model-to-the-data"

expression_meta_data_analysis6_nested_model <- expression_meta_data_analysis6_nested |> 
  mutate(model_object = map(.x = data,
                            .f = ~lm(formula = expression ~ overall_survival,
                                   data = .x)))

expression_meta_data_analysis6_nested_model
```

Computing the confidence intervals and p-value using tidy()

```{r}
#| label: "computing-CI-using-tidy"

expression_meta_data_analysis6_nested_model_tidy <- expression_meta_data_analysis6_nested_model |> 
  mutate(model_object_tidy = map(.x = model_object,
                                 .f = ~ tidy(conf.int = TRUE,
                                             conf.level = 0.95,
                                             x =.x)))

expression_meta_data_analysis6_nested_model_tidy
```

## Wrangling the expression data estimates

```{r}
#| label: "unnest-data"

expression_meta_data_analysis6_estimates <- expression_meta_data_analysis6_nested_model_tidy |>
  unnest(model_object_tidy)

expression_meta_data_analysis6_estimates

```

## Clean the data and calculating q.value

Term describes if the patient is dead or alive. 0 = alive and 1 = dead. Therefore the intercept is alive and the slope + intercept is dead. **Is this correct??? Explain better???**

-   make with smoking or non smoking?

```{r}
#| label: "filtering-and-selecting"

expression_meta_data_analysis6_estimates_clean <- expression_meta_data_analysis6_estimates |> 
  filter(term == "overall_survival") |> 
  select(peptide_target,
         p.value,
         estimate,
         conf.low,
         conf.high) |> 
  ungroup(peptide_target)

expression_meta_data_analysis6_estimates_clean
```

Adding the adjusted p-value in a new variable, q.value, and add extra variable that tells if the q-value is significant or not with alpha = 5%

```{r}
#| label: "mutate-is.significant"

expression_meta_data_analysis6_estimates_clean <- expression_meta_data_analysis6_estimates_clean |> 
  mutate(q.value = p.adjust(p = p.value),
         is_significant = case_when(q.value > 0.05 ~ "no",
                                    q.value <= 0.05 ~ "yes"))

expression_meta_data_analysis6_estimates_clean

```

```{r}
#| label: "filter-for-significant-proteins"

expression_meta_data_analysis6_estimates_clean |>  filter(is_significant == "yes")


```

We have 6 proteins where the expression levels are found to be significantly different between dead and alive patients.

## Forest plot

Creating a forest plot for significant genes using ggplot.

```{r}
#| label: "forest-plot"
#| fig-width: 8
#| fig-height: 5


forest_plot_vital <- expression_meta_data_analysis6_estimates_clean |> 
  filter(is_significant == "yes") |> 
  ggplot(mapping = aes(x = estimate,
                       y = fct_reorder(.f = peptide_target,
                                       .x = estimate))) + 
  geom_point(color = "#d11f2b") + 
  geom_vline(xintercept = 0,
             color = "#beeb4c",
             size = 1,
             alpha = 0.5) +
  geom_errorbarh(mapping = aes(xmin = conf.low,
                               xmax = conf.high),
                 size = 0.5,
                 height = 0.3,
                 color = "#eb4cbe") +
  theme_minimal() + 
  theme(plot.title = element_text(hjust = 0)) +
  labs(title = "Peptides associated with death of Head and Neck patients",
       x = "Estimates (95% CI)",
       y = "")

forest_plot_vital

ggsave(filename = "06_analysis_lm_forest_plot.png",
       plot = forest_plot_vital, 
       device = "png",
       path = "../results/images")

```

## Volcano plot

Creating a volcano plot to see up- and down regulated proteins.

```{r}
#| label: "volcano-plot"
#| fig-width: 8
#| fig-height: 5

expression_meta_data_analysis6_estimates_clean <- expression_meta_data_analysis6_estimates_clean |>
  mutate(label = case_when(is_significant == "yes" ~ peptide_target,
                           is_significant == "no" ~ ""))
expression_meta_data_analysis6_estimates_clean

volcano_plot_vital <- expression_meta_data_analysis6_estimates_clean |>
  ggplot(mapping = aes(x = estimate,
                       y = -log10(p.value),
                       color = is_significant)) +
  geom_point(alpha = 0.5) +
  scale_color_manual(values = c("yes" =  "#2bd11f", 
                                "no" ="#eb4cbe")) + 
  geom_label_repel(aes(label = label),
                   size = 4,
                   max.overlaps = 25) +
  labs(title = "Peptides associated with death of Head and Neck patients",
       subtitle = "Peptides with a label were significant after multiple testing correction",
       x = "Estimates",
       y = "-log10(p)") +
  theme_minimal(base_size = 12) +
  theme(plot.title = element_text(hjust = 0),
        plot.subtitle = element_text(hjust = 0),
        legend.position = "none") 

volcano_plot_vital

ggsave(filename = "06_analysis_lm_volcano_vital.png",
       plot = volcano_plot_vital, 
       device = "png",
       path = "../results/images")

```
